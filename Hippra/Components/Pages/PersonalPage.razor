@page "/PersonalPage/{userId}"
@rendermode @(new InteractiveServerRenderMode(false))
@using System.ComponentModel.DataAnnotations
@using Hippra.Models.DTO
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using System.Text
@using System.Text.Encodings.Web
@using Hippra.Models.FTDesign
@using Hippra.Services
@using Hippra.Models.SQL
@using Hippra.Models.POCO
@using Hippra.Models.Enums
@using System.Security.Claims
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor httpContextAccessor
@inject IJSRuntime JSRuntime
@inject Microsoft.AspNetCore.Components.NavigationManager NavigationManager
@inject HippraService hService
@inject ProfileService pService;
@inject CommonService commonService;
@using Microsoft.AspNetCore.Mvc.Rendering;
@using Hippra.Extensions
@inject IAuthorizationService AuthorizationService
@inject IHttpContextAccessor httpContextAccessor
@inject IFollowService followService;
<div class="profile-layout">
    <!-- Profile Top Frame -->
    <section class="profile-frame no-pad">
        <div class="profile-frame-inner">
            <!-- PRofile Informations -->
            <div class="profile-frame-user">
                <div class="profile-frame-img">
                    <div class="image-upload circle-pic" style="background-image: url('@DisplayProfileUrl');background-size: 100%;">
                    </div>
                </div>
                <div class="profile-frame-info">
                    <h4>@profile.FirstName</h4>
                    <h5>
                        @EnumsHelper.GetDisplayName(profile.MedicalSpecialty) at @profile.ResidencyHospital
                        @if (@profile.ResidencyHospital != null)
                        {
                            <span>@EnumsHelper.GetDisplayName(profile.MedicalSpecialty) at @profile.ResidencyHospital</span>
                        }
                        else
                        {
                            <span class="usr-loc">@EnumsHelper.GetDisplayName(profile.MedicalSpecialty)</span>
                        }
                    </h5>
                    <p>@profile.State</p>
                    <div class="profile-frame-social">
                        <div class="profile-social-item">
                            <a href=""><strong>@NrOfFollowers</strong> Followers</a>
                        </div>
                        <div class="profile-social-item">
                            <a href=""><strong>@NrOfFollowing</strong> Following</a>
                        </div>
                        @if(!IsMyOwnProfile)
                        {
                            @if (isFollowed)
                            {
                                <button class="prof-f-btn" @onclick="@RemoveFromFollowerList">Followed</button>
                            }
                            else
                            {
                                <button class="prof-f-btn" @onclick="@AddToFollowerList">Follow+</button>
                            }
                        }
                    </div>
                </div>
            </div>
            <div class="profile-frame-logo">
                <img src="./img/logo-lg.png" alt="">
            </div>
        </div>
    </section>
    <!-- Profile Content -->
    <section class="profile-content">
        <div class="profile-content-left">
            <!-- Profile About -->
            <div class="profile-about">
                <div class="content-heading">
                    <h4>About @profile.FirstName</h4>
                </div>
                <p>@profile.Bio</p>
                <hr>
            </div>
            <!--Profile Sepciality  -->
            <div class="profile-speciality">
                <div class="content-heading">
                    <h4>Speciality</h4>
                </div>
                <!-- Profile Sepciality Tag Loop Here -->
                <div class="profile-tags">
                    <ul>
                        <li>  @EnumsHelper.GetDisplayName(profile.MedicalSpecialty)</li>
                    </ul>
                </div>
            </div>
            <!-- Profile Contact -->
            <div class="profile-contact">
                <div class="content-heading">
                    <h4>Contact</h4>
                </div>
                <div class="profile-contact-info">
                    <div class="profile-contact-item">
                        <label for="">Email</label>
                        <div class="profile-contact-box">
                            @profile.Email
                        </div>
                    </div>
                    <div class="profile-contact-item">
                        <label for="">Phone</label>
                        <div class="profile-contact-box">
                            @profile.PhoneNumber
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Past Activities -->
        <div class="profile-content-right">
            <div class="profile-activities">
                <div class="content-heading">
                    <h4>Past Activities</h4>
                </div>
                <div class="profile-activities-list">
                    @foreach (var c in ListOfCases)
                    {
                        <div class="activities-list-item @c.CaseCssClass">
                            <div class="activity-top">
                                <div class="activity-date">
                                    <p>@c.DateLastUpdated.ToShortDateString()</p>
                                </div>
                                <div class="activity-caption">
                                    <a href=@($"/viewcase/{c.ID}")>@c.Topic</a>
                                </div>
                                <div class="activity-content">
                                    <p>
                                        @c.Description.Left(200) ...
                                    </p>
                                </div>

                            </div>
                            <div class="activity-bot">
                                <div class="activity-bot-actions">
                                    <button class="activity-action-btn">
                                        <img src="./img/icons/message-green.svg" alt="">
                                    </button>
                                    <button class="activity-action-btn">
                                        <img src="./img/icons/bookmark-green.svg" alt="">
                                    </button>
                                    <button class="activity-action-btn">
                                        <img src="./img/icons/three-dots-green.svg" alt="">
                                    </button>
                                </div>
                                <a href=@($"/viewcase/{c.ID}")><img src="./img/icons/arrow-right-green.svg" alt=""></a>
                            </div>
                        </div>
                    }

                </div>
            </div>
        </div>
    </section>
</div>

@code {
    [Parameter]
    public string userId { get; set; }
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    private AuthenticationState authState { get; set; }
    private List<ParsedCase> ListOfCases { get; set; } = new List<ParsedCase>();
    private Profile profile { get; set; } = new Profile();
    private string DisplayProfileUrl = "";
    private bool IsLoading = true;
    private string currentUserId { get; set; }
    private bool isFollowed = false;
    private int NrOfFollowers { get; set; }
    private int NrOfFollowing { get; set; }
    private bool IsMyOwnProfile { get; set; } = false;
    protected override async Task OnInitializedAsync()
    {
        authState = await authenticationStateTask;
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            try
            {
                currentUserId = user.Claims.FirstOrDefault(s => s.Type == "UserId")?.Value;
                isFollowed = await followService.CheckFollower(currentUserId, userId);
                NrOfFollowers = await followService.GetNrOfFollowers(userId);
                NrOfFollowing = await followService.GetNrOfFollowing(userId);
                if (userId == currentUserId)
                    IsMyOwnProfile = true;
            }
            catch (FormatException e)
            {
                Console.WriteLine(e.Message);
            }
        }

        //profile
        profile = new Profile();
        profile = await pService.GetProfileById(userId);
        if (profile.ProfileUrl != null)
        {
            DisplayProfileUrl = profile.ProfileUrl;
        }
        else
        {
            DisplayProfileUrl = "/img/hippra/blank-profile.png";
        }

        await GetCases();
    }

    protected override async Task OnParametersSetAsync()
    {
        // authState = await authenticationStateTask;
        // user = authState.User;
    }


    private async Task GetCases()
    {
        ListOfCases = new List<ParsedCase>();

        var searchResults = await hService.GetMyCases(userId);

        ListOfCases = ParsedCase.FromEntityList(searchResults.Cases).ToList();

        IsLoading = false;
    }

    private async Task AddToFollowerList()
    {
        await followService.AddFollower(userId, currentUserId);
        isFollowed = true;
        NrOfFollowers++;
        // await addToHistory("followed");
        // await Notify(-1);
        StateHasChanged();
    }

    private async Task RemoveFromFollowerList()
    {
        await followService.RemoveFollower(userId, currentUserId);
        isFollowed = false;
        NrOfFollowers--;
        // await addToHistory("unfollowed");
        StateHasChanged();
    }

}

